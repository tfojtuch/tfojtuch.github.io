<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"â€” ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><title data-react-helmet="true">Error handling with Apollo Server | Tomek&#x27;s blog</title><link rel="icon" href="/blog/icons/icon-48x48.png?v=5df4236cc5a55518734fb9d63ac8c975"/><link rel="manifest" href="/blog/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/blog/icons/icon-48x48.png?v=5df4236cc5a55518734fb9d63ac8c975"/><link rel="apple-touch-icon" sizes="72x72" href="/blog/icons/icon-72x72.png?v=5df4236cc5a55518734fb9d63ac8c975"/><link rel="apple-touch-icon" sizes="96x96" href="/blog/icons/icon-96x96.png?v=5df4236cc5a55518734fb9d63ac8c975"/><link rel="apple-touch-icon" sizes="144x144" href="/blog/icons/icon-144x144.png?v=5df4236cc5a55518734fb9d63ac8c975"/><link rel="apple-touch-icon" sizes="192x192" href="/blog/icons/icon-192x192.png?v=5df4236cc5a55518734fb9d63ac8c975"/><link rel="apple-touch-icon" sizes="256x256" href="/blog/icons/icon-256x256.png?v=5df4236cc5a55518734fb9d63ac8c975"/><link rel="apple-touch-icon" sizes="384x384" href="/blog/icons/icon-384x384.png?v=5df4236cc5a55518734fb9d63ac8c975"/><link rel="apple-touch-icon" sizes="512x512" href="/blog/icons/icon-512x512.png?v=5df4236cc5a55518734fb9d63ac8c975"/><meta name="generator" content="Gatsby 2.19.17"/><meta data-react-helmet="true" content="About: handling errors with Apollo Server; translating system-wide, service-specific and unexpected errors into Apolloâ€™s errors; without reimplementation of aâ€¦" name="description"/><meta data-react-helmet="true" content="Error handling with Apollo Server" property="og:title"/><meta data-react-helmet="true" content="About: handling errors with Apollo Server; translating system-wide, service-specific and unexpected errors into Apolloâ€™s errors; without reimplementation of aâ€¦" property="og:description"/><meta data-react-helmet="true" content="website" property="og:type"/><style data-href="/blog/styles.b2faaa3cebe5d9ff4bd2.css">@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/blog/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/blog/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/blog/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/blog/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/blog/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/blog/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/blog/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/blog/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/blog/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/blog/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/blog/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/blog/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/blog/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/blog/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/blog/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/blog/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/blog/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/blog/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/blog/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/blog/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/blog/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/blog/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/blog/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/blog/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/blog/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/blog/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/blog/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/blog/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/blog/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/blog/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/blog/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/blog/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/blog/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/blog/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/blog/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/blog/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/blog/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/blog/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/blog/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/blog/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/blog/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/blog/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/blog/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/blog/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/blog/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/blog/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/blog/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/blog/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/blog/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/blog/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/blog/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/blog/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}.grvsc-container-additional{border:1px solid rgba(0,0,0,.1)}ol,ul{padding-left:32px;text-align:left}</style><style data-styled="" data-styled-version="5.0.1">.hnNsNg{font-family:Montserrat,sans-serif;margin-top:0;}
data-styled.g1[id="layout__StyledH2-cejxee-0"]{content:"hnNsNg,"}
.dvOsTf{box-shadow:none;color:inherit;-webkit-text-decoration:none;text-decoration:none;}
data-styled.g2[id="layout__StyledLink-cejxee-1"]{content:"dvOsTf,"}
.kEKHUO{margin-left:auto;margin-right:auto;max-width:43.75rem;padding:2.625rem 1.3125rem;}
data-styled.g3[id="layout__Content-cejxee-2"]{content:"kEKHUO,"}
.bIuYxM{display:block;font-size:0.83255rem;line-height:1.75rem;margin-bottom:1.75rem;margin-top:-1.75rem;}
data-styled.g4[id="blog-post__Date-eho2rb-0"]{content:"bIuYxM,"}
.jvjEUU{margin-bottom:1.75rem;}
data-styled.g5[id="blog-post__Divider-eho2rb-1"]{content:"jvjEUU,"}
.kmhqYf{text-align:justify;}
data-styled.g6[id="blog-post__Content-eho2rb-2"]{content:"kmhqYf,"}
.dHdzzE{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;list-style:none;padding:0;}
data-styled.g7[id="blog-post__PostNavigator-eho2rb-3"]{content:"dHdzzE,"}
</style><link as="script" rel="preload" href="/blog/component---src-templates-blog-post-tsx-52cdd10a98d92531f1e9.js"/><link as="script" rel="preload" href="/blog/commons-58851888e1dee723d827.js"/><link as="script" rel="preload" href="/blog/app-8ed3204e5c27ae2d5728.js"/><link as="script" rel="preload" href="/blog/styles-e4a06a68ee395de1b9be.js"/><link as="script" rel="preload" href="/blog/webpack-runtime-3ec63951e6c48ee606df.js"/><link as="fetch" rel="preload" href="/blog/page-data\error-handling-with-apollo-server\page-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout__Content-cejxee-2 kEKHUO"><header><h2 class="layout__StyledH2-cejxee-0 hnNsNg"><a class="layout__StyledLink-cejxee-1 dvOsTf" href="/blog/">Tomek&#x27;s blog</a></h2></header><main><h1>Error handling with Apollo Server</h1><p class="blog-post__Date-eho2rb-0 bIuYxM">February 01, 2020</p><div class="blog-post__Content-eho2rb-2 kmhqYf"><p>About: handling errors with Apollo Server; translating system-wide, service-specific and unexpected errors into Apolloâ€™s errors; without reimplementation of a current system while transitioning from REST to GraphQL; type-safe with Typescript;</p>
<p>GraphQL is recently gaining popularity and many organizations are evaluating how they can benefit from GraphQL capabilities in their systems. There is a range of topics to consider while transitioning from a REST-based to a GraphQL-based system, one of them being error handling. In this post Iâ€™d like to share findings related to error handling with Apollo Server and in the <a href="/blog/error-handling-with-apollo-client/">next post</a> Iâ€™ll cover client side. Error handling capabilities provided by Apollo Server are described in <a href="https://www.apollographql.com/docs/apollo-server/data/errors/">Apollo Server documentation</a> and <a href="https://blog.apollographql.com/full-stack-error-handling-with-graphql-apollo-5c12da407210">Apollo blog</a>, not repeating information provided there, letâ€™s focus on how we could use those capabilities in a typical use case.</p>
<p>Our starting point is a REST-based system divided into layers:</p>
<ul>
<li>controllers layer - handling HTTP communication</li>
<li>services layer - implementing business logic</li>
<li>possibly more layers below the services layer (E.g. a model layer handling data access)</li>
</ul>
<p>In our current system <a href="https://javascript.info/custom-errors#wrapping-exceptions">error wrapping</a> technique is used so that a layer above only has to know how to handle errors thrown by a layer below with which it directly communicates, without having to be aware of any layers down the stack. In this setup the services layer wraps all errors that are coming from layers below and communicates them to the controllers layer that translates them into an appropriate HTTP code.</p>
<p>What we want to achieve is to make a transition to a GraphQL-based system without reimplementing the services layer and layers below. We can do that by either replacing REST controllers with GraphQL resolvers or placing resolvers next to controllers - in case the current REST-based setup should still work. Either way, we want to keep the services layer and layers below intact.</p>
<p>Letâ€™s group into categories errors that we have to handle:</p>
<ol>
<li>System-wide errors, not specific to one service, E.g. an error thrown when an unauthenticated user tries to access a non-public resource. This kind of error can be thrown by many different services in our system.</li>
<li>Service-specific errors, E.g. an error thrown by <em>addUser</em> service when the provided email has already been registered in our system. This kind of error is limited to one service.</li>
<li>Unexpected errors - all other errors: i/o errors, bugs in source code or projectâ€™s dependencies, etc.</li>
</ol>
<p>Before we jump into solutions how to handle these errors letâ€™s shortly cover what Apollo Server capabilities we can use. GraphQL-based systems convey information about errors using <em>errors</em> array, the array contains GraphQL errors serialized on the server side and deserialized on the client side. Type of an error is lost in the process, so Apollo Server to each error adds <em>extensions</em> object with <em>code</em> property. Value of this property conveys information of a type of the error. Apollo server provides several error classes implemented in <a href="https://github.com/apollographql/apollo-server/blob/master/packages/apollo-server-errors/src/index.ts">apollo-server-errors package</a>:</p>
<ul>
<li>SyntaxError (extensions.code: <em>GRAPHQL_PARSE_FAILED</em>) - thrown when a server receives a malformed query: E.g. without closing parenthesis. This type of error is handled by Apollo Server itself and doesnâ€™t reach the resolvers layer.</li>
<li>ValidationError (extensions.code: <em>GRAPHQL_VALIDATION_FAILED</em>) - thrown when a server receives a request non-compliant to GraphQL schema: E.g. with non-existent field names. Also handled by Apollo Server itself.</li>
<li>AuthenticationError (extensions.code: <em>UNAUTHENTICATED</em>) - This error type we can use in resolvers when the user in unauthenticated.</li>
<li>ForbiddenError (extensions.code: <em>FORBIDDEN</em>) - Can be used in resolvers when the user in unauthorized to perform a given action.</li>
<li>UserInputError - We can used it to inform that the submitted input is invalid.</li>
<li>PersistedQueryNotFoundError (extensions.code: <em>PERSISTED_QUERY_NOT_FOUND</em>) - only for persisted queries (more info: <a href="https://github.com/apollographql/apollo-link-persisted-queries">apollo-link-persisted-queries package</a>).</li>
<li>PersistedQueryNotSupportedError (extensions.code: <em>PERSISTED_QUERY_NOT_SUPPORTED</em>) - also only for persisted queries.</li>
</ul>
<p>All the above errors extend ApolloError class (extensions.code: <em>INTERNAL_SERVER_ERROR</em>), which can be used to create proprietary classes of errors.</p>
<p>In subsequent sections letâ€™s see how we can map errors generated by our system to errors provided by Apollo Server.</p>
<h2>1. Handling system-wide errors</h2>
<p>Examples of system-wide errors may include:</p>
<ol>
<li>an error thrown when an unauthenticated user tries to access a non-public resource - letâ€™s assume that is such a case our system throws our proprietary UserUnauthenticatedError and we would like to catch it and translate into Apolloâ€™s AuthenticationError for every resolver that may receive it.</li>
<li>an error thrown when the user is authenticated but tries to perform an action without having appropriate rights to do so - letâ€™s assume that in this case the system throws our proprietary UserUnauthorizedError and we want to translate it into Apolloâ€™s ForbiddenError for all resolvers.</li>
</ol>
<p>One way to throw Applloâ€™s errors instead the proprietary ones would be to replace proprietary errors with respective Apolloâ€™s errors in all places where these proprietary errors are thrown. But that would mean a lot of changes in existing source code and also the current REST-based setup would stop working unless we also reimplement the controllers layer. Another approach could be to put a try/catch clause in every resolver, but this would imply a lot of code repetition. Letâ€™s try different approach and create a higher order function that takes an asynchronous function as a parameter and returns a function with the same signature as a signature of the provided function. The returned function would invoke the provided function in an asynchronous way, surround it by a try/catch block and throw Apolloâ€™s AuthenticationError and ForbiddenError instead of our respective proprietary errors. In Javascript the higher order function could look like this:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="javascript" data-index="0"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk14">export</span><span class="mtk1"> </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">func</span><span class="mtk1">) {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk14">return</span><span class="mtk1"> </span><span class="mtk4">async</span><span class="mtk1"> (...</span><span class="mtk12">funcArgs</span><span class="mtk1">) </span><span class="mtk4">=&gt;</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk14">try</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk14">return</span><span class="mtk1"> </span><span class="mtk14">await</span><span class="mtk1"> </span><span class="mtk10">func</span><span class="mtk1">(...</span><span class="mtk12">funcArgs</span><span class="mtk1">);</span></span>
<span class="grvsc-line"><span class="mtk1">    } </span><span class="mtk14">catch</span><span class="mtk1"> (</span><span class="mtk12">error</span><span class="mtk1">) {</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk14">if</span><span class="mtk1"> (</span><span class="mtk12">error</span><span class="mtk1"> </span><span class="mtk4">instanceof</span><span class="mtk1"> </span><span class="mtk9">UserUnauthenticatedError</span><span class="mtk1">) {</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk3">// translate UserUnauthenticatedError into Apollo AuthenticationError</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">apolloError</span><span class="mtk1"> = </span><span class="mtk4">new</span><span class="mtk1"> </span><span class="mtk9">AuthenticationError</span><span class="mtk1">(</span><span class="mtk12">error</span><span class="mtk1">.</span><span class="mtk12">message</span><span class="mtk1">);</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk12">apolloError</span><span class="mtk1">.</span><span class="mtk12">originalError</span><span class="mtk1"> = </span><span class="mtk12">error</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk14">throw</span><span class="mtk1"> </span><span class="mtk12">apolloError</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">      } </span><span class="mtk14">else</span><span class="mtk1"> </span><span class="mtk14">if</span><span class="mtk1"> (</span><span class="mtk12">error</span><span class="mtk1"> </span><span class="mtk4">instanceof</span><span class="mtk1"> </span><span class="mtk9">UserUnauthorizedError</span><span class="mtk1">) {</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk3">// translate UserUnauthorizedError into Apollo ForbiddenError</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">apolloError</span><span class="mtk1"> = </span><span class="mtk4">new</span><span class="mtk1"> </span><span class="mtk9">ForbiddenError</span><span class="mtk1">(</span><span class="mtk12">error</span><span class="mtk1">.</span><span class="mtk12">message</span><span class="mtk1">);</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk12">apolloError</span><span class="mtk1">.</span><span class="mtk12">originalError</span><span class="mtk1"> = </span><span class="mtk12">error</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk14">throw</span><span class="mtk1"> </span><span class="mtk12">apolloError</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">      } </span><span class="mtk14">else</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk3">// re-throw all other errors</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk14">throw</span><span class="mtk1"> </span><span class="mtk12">error</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">      }</span></span>
<span class="grvsc-line"><span class="mtk1">    }</span></span>
<span class="grvsc-line"><span class="mtk1">  };</span></span>
<span class="grvsc-line"><span class="mtk1">}</span></span></code></pre>
<p>Now after passing resolvers through this function we would get all proprietary errors automatically translated. We can apply this function in the resolvers map to those resolvers that might potentially throw <em>UserUnauthenticatedError</em> or <em>UserUnauthorizedError</em>. In the following example we omit <em>addUser</em> and <em>sighIn</em> resolvers because operations associated with them are public, accessible for everyone, so they should not throw any of the errors we want to catch:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="javascript" data-index="1"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">translateErrors</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./errors&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">addUserResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./addUser&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">deleteUserResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./deleteUser&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">getUserResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./getUser&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">signInResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./signIn&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">signOutResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./signOut&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">updateUserNameResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./updateUserName&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">updateUserEmailResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./updateUserEmail&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">updateUserPasswordResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./updateUserPassword&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">updateUserPhoneResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./updateUserPhone&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"></span>
<span class="grvsc-line"><span class="mtk14">export</span><span class="mtk1"> </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">resolvers</span><span class="mtk1"> = {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">Query:</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">getUser:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">getUserResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">  },</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">Mutation:</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">addUser:</span><span class="mtk1"> </span><span class="mtk12">addUserResolver</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">deleteUser:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">deleteUserResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">signIn:</span><span class="mtk1"> </span><span class="mtk12">signInResolver</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">signOut:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">signOutResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">updateUserName:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">updateUserNameResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">updateUserEmail:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">updateUserEmailResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">updateUserPassword:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">updateUserPasswordResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">updateUserPhone:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">updateUserPhoneResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">  },</span></span>
<span class="grvsc-line"><span class="mtk1">};</span></span></code></pre>
<p>That would work in Javascript, but how could we achieve the same in Typescript, so that in the end we have a fully type-safe system? To annotate <em>translateErrors</em> function with appropriate types we have to use <a href="https://www.typescriptlang.org/docs/handbook/generics.html">generics</a> as we want to be able to pass an asynchronous function of any type to it. Letâ€™s start with a <a href="https://www.typescriptlang.org/docs/handbook/generics.html#generic-constraints">generic constraint</a>. The only constraint we want to impose is that a function passed as the argument should return a promise, so that we can invoke it in an asynchronous way. Apart from that we want the constraint to be as permissive as possible, the function can have any number of parameters of any type, as well as the promise that it returns can resolve to any type. We could use <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html#any">any</a> type for that, but that wouldnâ€™t be type-safe (and also our linter would complain :) ). So how can we do that in a type-safe way? First letâ€™s start with types of parameters. They are in contravariant position, so the most permissive type here is <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html#never">never</a>, as it is a subtype of, and assignable to, every type. We want to allow for any number of parameters so our parameters side of the constraint would be:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="2"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk1">(...</span><span class="mtk12">args</span><span class="mtk1">: </span><span class="mtk9">never</span><span class="mtk1">[])</span></span></code></pre>
<p>What about the return part of the constraint? We could use <a href="https://www.typescriptlang.org/docs/handbook/utility-types.html#returntypet">ReturnType&#x3C;T></a> which is a build-in utility type provided by Typescript, but we cannot do that as the function must return a promise. So letâ€™s build our own <a href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#conditional-types">conditional type</a> inferring a return type unpacked from a promise. Letâ€™s call it <em>UnpromisifiedReturnType&#x3C;T></em>. In contravariant position we are going to use any number of arguments of type <em>never</em> and in covariant position we are going to use type <a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-3-0.html#new-unknown-top-type">unknown</a>, since anything is assignable to <em>unknown</em>, but <em>unknown</em> is not assignable to anything:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="3"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk4">type</span><span class="mtk1"> </span><span class="mtk9">UnpromisifiedReturnType</span><span class="mtk1">&lt;</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk9">T</span><span class="mtk1"> </span><span class="mtk4">extends</span><span class="mtk1"> (...</span><span class="mtk12">args</span><span class="mtk1">: </span><span class="mtk9">never</span><span class="mtk1">[]) </span><span class="mtk4">=&gt;</span><span class="mtk1"> </span><span class="mtk9">Promise</span><span class="mtk1">&lt;</span><span class="mtk9">unknown</span><span class="mtk1">&gt;</span></span>
<span class="grvsc-line"><span class="mtk1">&gt; = </span><span class="mtk9">T</span><span class="mtk1"> </span><span class="mtk4">extends</span><span class="mtk1"> (...</span><span class="mtk12">args</span><span class="mtk1">: </span><span class="mtk9">never</span><span class="mtk1">[]) </span><span class="mtk4">=&gt;</span><span class="mtk1"> </span><span class="mtk9">Promise</span><span class="mtk1">&lt;</span><span class="mtk4">infer</span><span class="mtk1"> </span><span class="mtk9">R</span><span class="mtk1">&gt; ? </span><span class="mtk9">R</span><span class="mtk1"> : </span><span class="mtk9">never</span><span class="mtk1">;</span></span></code></pre>
<p>In the example above when Typescript compiler is unable to infer type then returns <em>never</em>, and since nothing is assignable to <em>never</em> no type will be able to be assigned to it and the compiler will warn us about an improper assignment. Now we can build our generic constraint:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="4"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">&lt;</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk9">T</span><span class="mtk1"> </span><span class="mtk4">extends</span><span class="mtk1"> (...</span><span class="mtk12">args</span><span class="mtk1">: </span><span class="mtk9">never</span><span class="mtk1">[]) </span><span class="mtk4">=&gt;</span><span class="mtk1"> </span><span class="mtk9">Promise</span><span class="mtk1">&lt;</span><span class="mtk9">UnpromisifiedReturnType</span><span class="mtk1">&lt;</span><span class="mtk9">T</span><span class="mtk1">&gt;&gt;</span></span>
<span class="grvsc-line"><span class="mtk1">&gt;</span></span></code></pre>
<p>Next letâ€™s annotate return type of <em>translateErrors</em> function. To annotate it we can use another built-in utility type provided by Typescript: <a href="https://www.typescriptlang.org/docs/handbook/utility-types.html#parameterst">Parameters&#x3C;T></a>. The returned function should take the same types of parameters as the provided function (<em>Parameters&#x3C;T></em>) and should return a promise of unpromisified return type (<em>UnpromisifiedReturnType&#x3C;T></em>) With use of it return type of <em>translateErrors</em> function would be:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="5"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk4">type</span><span class="mtk1"> </span><span class="mtk9">AsyncFunction</span><span class="mtk1">&lt;</span><span class="mtk9">T</span><span class="mtk1"> </span><span class="mtk4">extends</span><span class="mtk1"> (...</span><span class="mtk12">args</span><span class="mtk1">: </span><span class="mtk9">never</span><span class="mtk1">[]) </span><span class="mtk4">=&gt;</span><span class="mtk1"> </span><span class="mtk9">Promise</span><span class="mtk1">&lt;</span><span class="mtk9">unknown</span><span class="mtk1">&gt;&gt; = (</span></span>
<span class="grvsc-line"><span class="mtk1">  ...</span><span class="mtk12">args</span><span class="mtk1">: </span><span class="mtk9">Parameters</span><span class="mtk1">&lt;</span><span class="mtk9">T</span><span class="mtk1">&gt;</span></span>
<span class="grvsc-line"><span class="mtk1">) </span><span class="mtk4">=&gt;</span><span class="mtk1"> </span><span class="mtk9">Promise</span><span class="mtk1">&lt;</span><span class="mtk9">UnpromisifiedReturnType</span><span class="mtk1">&lt;</span><span class="mtk9">T</span><span class="mtk1">&gt;&gt;;</span></span></code></pre>
<p>Ok, so now letâ€™s put all the blocks together:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="6"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk4">type</span><span class="mtk1"> </span><span class="mtk9">UnpromisifiedReturnType</span><span class="mtk1">&lt;</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk9">T</span><span class="mtk1"> </span><span class="mtk4">extends</span><span class="mtk1"> (...</span><span class="mtk12">args</span><span class="mtk1">: </span><span class="mtk9">never</span><span class="mtk1">[]) </span><span class="mtk4">=&gt;</span><span class="mtk1"> </span><span class="mtk9">Promise</span><span class="mtk1">&lt;</span><span class="mtk9">unknown</span><span class="mtk1">&gt;</span></span>
<span class="grvsc-line"><span class="mtk1">&gt; = </span><span class="mtk9">T</span><span class="mtk1"> </span><span class="mtk4">extends</span><span class="mtk1"> (...</span><span class="mtk12">args</span><span class="mtk1">: </span><span class="mtk9">never</span><span class="mtk1">[]) </span><span class="mtk4">=&gt;</span><span class="mtk1"> </span><span class="mtk9">Promise</span><span class="mtk1">&lt;</span><span class="mtk4">infer</span><span class="mtk1"> </span><span class="mtk9">R</span><span class="mtk1">&gt; ? </span><span class="mtk9">R</span><span class="mtk1"> : </span><span class="mtk9">never</span><span class="mtk1">;</span></span>
<span class="grvsc-line"></span>
<span class="grvsc-line"><span class="mtk4">type</span><span class="mtk1"> </span><span class="mtk9">AsyncFunction</span><span class="mtk1">&lt;</span><span class="mtk9">T</span><span class="mtk1"> </span><span class="mtk4">extends</span><span class="mtk1"> (...</span><span class="mtk12">args</span><span class="mtk1">: </span><span class="mtk9">never</span><span class="mtk1">[]) </span><span class="mtk4">=&gt;</span><span class="mtk1"> </span><span class="mtk9">Promise</span><span class="mtk1">&lt;</span><span class="mtk9">unknown</span><span class="mtk1">&gt;&gt; = (</span></span>
<span class="grvsc-line"><span class="mtk1">  ...</span><span class="mtk12">args</span><span class="mtk1">: </span><span class="mtk9">Parameters</span><span class="mtk1">&lt;</span><span class="mtk9">T</span><span class="mtk1">&gt;</span></span>
<span class="grvsc-line"><span class="mtk1">) </span><span class="mtk4">=&gt;</span><span class="mtk1"> </span><span class="mtk9">Promise</span><span class="mtk1">&lt;</span><span class="mtk9">UnpromisifiedReturnType</span><span class="mtk1">&lt;</span><span class="mtk9">T</span><span class="mtk1">&gt;&gt;;</span></span>
<span class="grvsc-line"></span>
<span class="grvsc-line"><span class="mtk14">export</span><span class="mtk1"> </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">&lt;</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk9">T</span><span class="mtk1"> </span><span class="mtk4">extends</span><span class="mtk1"> (...</span><span class="mtk12">args</span><span class="mtk1">: </span><span class="mtk9">never</span><span class="mtk1">[]) </span><span class="mtk4">=&gt;</span><span class="mtk1"> </span><span class="mtk9">Promise</span><span class="mtk1">&lt;</span><span class="mtk9">UnpromisifiedReturnType</span><span class="mtk1">&lt;</span><span class="mtk9">T</span><span class="mtk1">&gt;&gt;</span></span>
<span class="grvsc-line"><span class="mtk1">&gt;(</span><span class="mtk12">func</span><span class="mtk1">: </span><span class="mtk9">T</span><span class="mtk1">): </span><span class="mtk9">AsyncFunction</span><span class="mtk1">&lt;</span><span class="mtk9">T</span><span class="mtk1">&gt; {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk14">return</span><span class="mtk1"> </span><span class="mtk4">async</span><span class="mtk1"> (</span></span>
<span class="grvsc-line"><span class="mtk1">    ...</span><span class="mtk12">funcArgs</span><span class="mtk1">: </span><span class="mtk9">Parameters</span><span class="mtk1">&lt;</span><span class="mtk9">T</span><span class="mtk1">&gt;</span></span>
<span class="grvsc-line"><span class="mtk1">  ): </span><span class="mtk9">Promise</span><span class="mtk1">&lt;</span><span class="mtk9">UnpromisifiedReturnType</span><span class="mtk1">&lt;</span><span class="mtk9">T</span><span class="mtk1">&gt;&gt; </span><span class="mtk4">=&gt;</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk14">try</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk14">return</span><span class="mtk1"> </span><span class="mtk14">await</span><span class="mtk1"> </span><span class="mtk10">func</span><span class="mtk1">(...</span><span class="mtk12">funcArgs</span><span class="mtk1">);</span></span>
<span class="grvsc-line"><span class="mtk1">    } </span><span class="mtk14">catch</span><span class="mtk1"> (</span><span class="mtk12">error</span><span class="mtk1">) {</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk14">if</span><span class="mtk1"> (</span><span class="mtk12">error</span><span class="mtk1"> </span><span class="mtk4">instanceof</span><span class="mtk1"> </span><span class="mtk9">UserUnauthenticatedError</span><span class="mtk1">) {</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk3">// translate UserUnauthenticatedError into Apollo&#39;s AuthenticationError</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">apolloError</span><span class="mtk1"> = </span><span class="mtk4">new</span><span class="mtk1"> </span><span class="mtk9">AuthenticationError</span><span class="mtk1">(</span><span class="mtk12">error</span><span class="mtk1">.</span><span class="mtk12">message</span><span class="mtk1">);</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk12">apolloError</span><span class="mtk1">.</span><span class="mtk12">originalError</span><span class="mtk1"> = </span><span class="mtk12">error</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk14">throw</span><span class="mtk1"> </span><span class="mtk12">apolloError</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">      } </span><span class="mtk14">else</span><span class="mtk1"> </span><span class="mtk14">if</span><span class="mtk1"> (</span><span class="mtk12">error</span><span class="mtk1"> </span><span class="mtk4">instanceof</span><span class="mtk1"> </span><span class="mtk9">UserUnauthorizedError</span><span class="mtk1">) {</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk3">// translate UserUnauthorizedError into Apollo&#39;s ForbiddenError</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">apolloError</span><span class="mtk1"> = </span><span class="mtk4">new</span><span class="mtk1"> </span><span class="mtk9">ForbiddenError</span><span class="mtk1">(</span><span class="mtk12">error</span><span class="mtk1">.</span><span class="mtk12">message</span><span class="mtk1">);</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk12">apolloError</span><span class="mtk1">.</span><span class="mtk12">originalError</span><span class="mtk1"> = </span><span class="mtk12">error</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk14">throw</span><span class="mtk1"> </span><span class="mtk12">apolloError</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">      } </span><span class="mtk14">else</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk3">// re-throw all other errors</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk14">throw</span><span class="mtk1"> </span><span class="mtk12">error</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">      }</span></span>
<span class="grvsc-line"><span class="mtk1">    }</span></span>
<span class="grvsc-line"><span class="mtk1">  };</span></span>
<span class="grvsc-line"><span class="mtk1">}</span></span></code></pre>
<p>As a result we have a function that takes an asynchronous function and returns another asynchronous function of exactly the same signature as the one that was passed in. The returned function invokes the passed in function in an asynchronous way, catches proprietary errors and throws Apolloâ€™s errors instead.</p>
<p>Now we have to apply that function to resolvers. We might be tempted to apply it to all resolvers in a loop, for example by using <em>Object.entries</em> or <em>for/in</em> with <em>hasOwnProperty</em>. But there is an important caveat: by doing so we loose type safety as Typescript while looping through an object casts types of all values to <em>any</em>. What at most we could do is to invoke <em>Object.entries</em> with type variable set to the most permissive asynchronous function, E.g. like this:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="7"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk9">Object</span><span class="mtk1">.</span><span class="mtk10">values</span><span class="mtk1">(</span><span class="mtk12">resolvers</span><span class="mtk1">).</span><span class="mtk10">forEach</span><span class="mtk1">(</span><span class="mtk12">resolverGroup</span><span class="mtk1"> </span><span class="mtk4">=&gt;</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk9">Object</span><span class="mtk1">.</span><span class="mtk10">entries</span><span class="mtk1">&lt;(...</span><span class="mtk12">args</span><span class="mtk1">: </span><span class="mtk9">never</span><span class="mtk1">[]) </span><span class="mtk4">=&gt;</span><span class="mtk1"> </span><span class="mtk9">Promise</span><span class="mtk1">&lt;</span><span class="mtk9">unknown</span><span class="mtk1">&gt;&gt;(</span><span class="mtk12">resolverGroup</span><span class="mtk1">).</span><span class="mtk10">forEach</span><span class="mtk1">(</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">entry</span><span class="mtk1"> </span><span class="mtk4">=&gt;</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk12">resolverGroup</span><span class="mtk1">[</span><span class="mtk12">entry</span><span class="mtk1">[</span><span class="mtk7">0</span><span class="mtk1">]] = </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">entry</span><span class="mtk1">[</span><span class="mtk7">1</span><span class="mtk1">]);</span></span>
<span class="grvsc-line"><span class="mtk1">    },</span></span>
<span class="grvsc-line"><span class="mtk1">  );</span></span>
<span class="grvsc-line"><span class="mtk1">});</span></span></code></pre>
<p>Then the compiler would at least catch if we try to pass a synchronous function instead of an asynchronous one, but still would not be able to warn about arguments or a return type not conforming to our GraphQL schema. So letâ€™s apply the function selectively, but before we do that letâ€™s add one more tool to our system: <a href="https://github.com/dotansimha/graphql-code-generator">graphql code generator</a>. Itâ€™s a tool that can generate Typescript types based on GraphQL schema. Out of generated types we are going to use <em>MutationResolvers</em>, <em>QueryResolvers</em> and <em>ResolversObject</em> in our resolvers map. Now letâ€™s see how the map looks like in Typescript:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="8"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">MutationResolvers</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">QueryResolvers</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">ResolversObject</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">} </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;../graphql/generated&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">translateErrors</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./errors&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">addUserResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./addUser&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">deleteUserResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./deleteUser&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">getUserResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./getUser&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">signInResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./signIn&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">signOutResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./signOut&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">updateUserNameResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./updateUserName&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">updateUserEmailResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./updateUserEmail&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">updateUserPasswordResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./updateUserPassword&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">updateUserPhoneResolver</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./updateUserPhone&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"></span>
<span class="grvsc-line"><span class="mtk4">type</span><span class="mtk1"> </span><span class="mtk9">Resolvers</span><span class="mtk1"> = </span><span class="mtk9">ResolversObject</span><span class="mtk1">&lt;{</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">Query</span><span class="mtk1">: </span><span class="mtk9">QueryResolvers</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">Mutation</span><span class="mtk1">: </span><span class="mtk9">MutationResolvers</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">}&gt;;</span></span>
<span class="grvsc-line"></span>
<span class="grvsc-line"><span class="mtk14">export</span><span class="mtk1"> </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">resolvers</span><span class="mtk1">: </span><span class="mtk9">Resolvers</span><span class="mtk1"> = {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">Query:</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">getUser:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">getUserResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">  },</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">Mutation:</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">addUser:</span><span class="mtk1"> </span><span class="mtk12">addUserResolver</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">deleteUser:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">deleteUserResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">signIn:</span><span class="mtk1"> </span><span class="mtk12">signInResolver</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">signOut:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">signOutResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">updateUserName:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">updateUserNameResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">updateUserEmail:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">updateUserEmailResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">updateUserPassword:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">updateUserPasswordResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">updateUserPhone:</span><span class="mtk1"> </span><span class="mtk10">translateErrors</span><span class="mtk1">(</span><span class="mtk12">updateUserPhoneResolver</span><span class="mtk1">),</span></span>
<span class="grvsc-line"><span class="mtk1">  },</span></span>
<span class="grvsc-line"><span class="mtk1">};</span></span></code></pre>
<p>In this case <em>translateErrors</em> function translates only two errors but we can expand it to cover more types of errors based on our systemâ€™s needs. And also in case the underlying system is not so uniform we can provide more than one <em>translateErrors</em> functions, each suited to unique needs of part of the system. To any resolver several such functions can be applied. Also some of them can return non-asynchronous functions in case part of the system works in a synchronous way.</p>
<p>Letâ€™s wrap up, with this setup we donâ€™t have to make any modifications to our underlying system, nor do we have to duplicate try/catch blocks for system-wide errors in every resolver. And by using types generated by <em>graphql code generator</em> we gain full type safety of the system: when we forget to cover some of queries or mutations with resolvers or use a resolver with incorrect set of arguments or return type then it is going to be caught in the compilation phase.</p>
<p>Now letâ€™s see how we can handle service-specific errors.</p>
<h2>2. Handling service-specific errors</h2>
<p>Service-specific errors might include for example:</p>
<ul>
<li><em>EmailExistsError</em> thrown by <em>addUser</em> service when the provided email is already registered in the system,</li>
<li><em>InvalidCredentialsError</em> thrown by <em>signIn</em> service when the user tries to sign in with invalid email or password,</li>
<li>etc.</li>
</ul>
<p>Errors like these are a result of usersâ€™ actions that donâ€™t pass server-side validation. Apollo Server provides special error type for handling errors like these: <em>UserInputError</em>. On instantiation its constructor function takes two arguments: required <em>message</em> and optional <em>properties</em>:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="9"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk14">export</span><span class="mtk1"> </span><span class="mtk4">class</span><span class="mtk1"> </span><span class="mtk9">UserInputError</span><span class="mtk1"> </span><span class="mtk4">extends</span><span class="mtk1"> </span><span class="mtk9">ApolloError</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk4">constructor</span><span class="mtk1">(</span><span class="mtk12">message</span><span class="mtk1">: </span><span class="mtk9">string</span><span class="mtk1">, </span><span class="mtk12">properties</span><span class="mtk1">?: </span><span class="mtk9">Record</span><span class="mtk1">&lt;</span><span class="mtk9">string</span><span class="mtk1">, </span><span class="mtk9">any</span><span class="mtk1">&gt;) {</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk4">super</span><span class="mtk1">(</span><span class="mtk12">message</span><span class="mtk1">, </span><span class="mtk17">&#39;BAD_USER_INPUT&#39;</span><span class="mtk1">, </span><span class="mtk12">properties</span><span class="mtk1">);</span></span>
<span class="grvsc-line"></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk9">Object</span><span class="mtk1">.</span><span class="mtk10">defineProperty</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">, </span><span class="mtk17">&#39;name&#39;</span><span class="mtk1">, { </span><span class="mtk12">value:</span><span class="mtk1"> </span><span class="mtk17">&#39;UserInputError&#39;</span><span class="mtk1"> });</span></span>
<span class="grvsc-line"><span class="mtk1">  }</span></span>
<span class="grvsc-line"><span class="mtk1">}</span></span></code></pre>
<p>To translate a service-specific error into <em>UserInputError</em> we can simply catch it in the resolver that invokes the service and use <em>properties</em> argument to <a href="https://www.apollographql.com/docs/apollo-server/data/errors/#augmenting-error-details">augment error details</a>. An issue with this approach is that errors are not part of GraphQL schema so any changes to error details have to be synchronized in all places where the error is consumed on the client side. Letâ€™s use Typescript compiler to check it for us and provide type safety also in this area.</p>
<p>First letâ€™s make <em>properties</em> argument mandatory by extending <em>UserInputError</em>:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="10"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk14">export</span><span class="mtk1"> </span><span class="mtk4">class</span><span class="mtk1"> </span><span class="mtk9">InvalidUserInputError</span><span class="mtk1"> </span><span class="mtk4">extends</span><span class="mtk1"> </span><span class="mtk9">UserInputError</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk4">constructor</span><span class="mtk1">(</span><span class="mtk12">message</span><span class="mtk1">: </span><span class="mtk9">string</span><span class="mtk1">, </span><span class="mtk12">properties</span><span class="mtk1">: </span><span class="mtk9">UserInputErrorProperties</span><span class="mtk1">) {</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk4">super</span><span class="mtk1">(</span><span class="mtk12">message</span><span class="mtk1">, </span><span class="mtk12">properties</span><span class="mtk1">);</span></span>
<span class="grvsc-line"><span class="mtk1">  }</span></span>
<span class="grvsc-line"><span class="mtk1">}</span></span></code></pre>
<p>Now we have to decide what shape <em>properties</em> object is going to have. For example we can decide that every <em>properties</em> object will contain:</p>
<ul>
<li><em>operation</em> property conveying information in which operation the error occurred</li>
<li><em>codes</em> property conveying information what type/types of errors occurred</li>
<li>other optional properties, for example communicating the actual error message to be displayed in case of a server-side i18n</li>
</ul>
<p>So every <em>properties</em> object would have to adhere to the following shape:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="11"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk4">interface</span><span class="mtk1"> </span><span class="mtk9">ErrorProperties</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">operation</span><span class="mtk1">: </span><span class="mtk9">UserInputOperation</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">codes</span><span class="mtk1">: </span><span class="mtk9">Array</span><span class="mtk1">&lt;</span><span class="mtk9">UserInputErrorCode</span><span class="mtk1">&gt;;</span></span>
<span class="grvsc-line"><span class="mtk1">}</span></span></code></pre>
<p>Letâ€™s use <a href="https://www.typescriptlang.org/docs/handbook/enums.html#string-enums">string enums</a> to assign string literals for three exemplary operations:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="12"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk14">export</span><span class="mtk1"> </span><span class="mtk4">enum</span><span class="mtk1"> </span><span class="mtk9">UserInputOperation</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">AddUser</span><span class="mtk1"> = </span><span class="mtk17">&quot;ADD_USER&quot;</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">SighIn</span><span class="mtk1"> = </span><span class="mtk17">&quot;SIGN_IN&quot;</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">UpdateUserEmail</span><span class="mtk1"> = </span><span class="mtk17">&quot;UPDATE_USER_EMAIL&quot;</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">}</span></span></code></pre>
<p>and three exemplary error codes:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="13"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk14">export</span><span class="mtk1"> </span><span class="mtk4">enum</span><span class="mtk1"> </span><span class="mtk9">UserInputErrorCode</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">EmailExists</span><span class="mtk1"> = </span><span class="mtk17">&quot;EMAIL_EXISTS&quot;</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">InvalidCredentials</span><span class="mtk1"> = </span><span class="mtk17">&quot;INVALID_CREDENTIALS&quot;</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">InvalidPassword</span><span class="mtk1"> = </span><span class="mtk17">&quot;INVALID_PASSWORD&quot;</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">}</span></span></code></pre>
<p>Next we export <em>UserInputOperation</em> and <em>UserInputErrorCode</em> as weâ€™ll be using them in resolvers. Now we have to decide which operations can send which error codes, for example:</p>
<p>Operation <em>ADD_USER</em> can send error code <em>EMAIL_EXISTS</em>:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="14"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk4">interface</span><span class="mtk1"> </span><span class="mtk9">AddUserErrorProperties</span><span class="mtk1"> </span><span class="mtk4">extends</span><span class="mtk1"> </span><span class="mtk9">ErrorProperties</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">operation</span><span class="mtk1">: </span><span class="mtk9">UserInputOperation</span><span class="mtk1">.</span><span class="mtk9">AddUser</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">codes</span><span class="mtk1">: </span><span class="mtk9">Array</span><span class="mtk1">&lt;</span><span class="mtk9">UserInputErrorCode</span><span class="mtk1">.</span><span class="mtk9">EmailExists</span><span class="mtk1">&gt;;</span></span>
<span class="grvsc-line"><span class="mtk1">}</span></span></code></pre>
<p>Operation <em>SIGN_IN</em> can send error code <em>INVALID_CREDENTIALS</em>:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="15"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk4">interface</span><span class="mtk1"> </span><span class="mtk9">SignInErrorProperties</span><span class="mtk1"> </span><span class="mtk4">extends</span><span class="mtk1"> </span><span class="mtk9">ErrorProperties</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">operation</span><span class="mtk1">: </span><span class="mtk9">UserInputOperation</span><span class="mtk1">.</span><span class="mtk9">SighIn</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">codes</span><span class="mtk1">: </span><span class="mtk9">Array</span><span class="mtk1">&lt;</span><span class="mtk9">UserInputErrorCode</span><span class="mtk1">.</span><span class="mtk9">InvalidCredentials</span><span class="mtk1">&gt;;</span></span>
<span class="grvsc-line"><span class="mtk1">}</span></span></code></pre>
<p>And operation <em>UPDATE_USER_EMAIL</em> can send error codes <em>EMAIL_EXISTS</em> and <em>INVALID_PASSWORD</em>:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="16"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk4">interface</span><span class="mtk1"> </span><span class="mtk9">UpdateUserEmailErrorProperties</span><span class="mtk1"> </span><span class="mtk4">extends</span><span class="mtk1"> </span><span class="mtk9">ErrorProperties</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">operation</span><span class="mtk1">: </span><span class="mtk9">UserInputOperation</span><span class="mtk1">.</span><span class="mtk9">UpdateUserEmail</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">codes</span><span class="mtk1">: </span><span class="mtk9">Array</span><span class="mtk1">&lt;</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk9">UserInputErrorCode</span><span class="mtk1">.</span><span class="mtk9">EmailExists</span><span class="mtk1"> | </span><span class="mtk9">UserInputErrorCode</span><span class="mtk1">.</span><span class="mtk9">InvalidPassword</span></span>
<span class="grvsc-line"><span class="mtk1">  &gt;;</span></span>
<span class="grvsc-line"><span class="mtk1">}</span></span></code></pre>
<p>If any operation needs additional properties for handling an error on the client side then we can add them next to <em>operation</em> and <em>codes</em> properties. In resolvers we can import these interfaces either individually or we can group them into an union and use Typescriptâ€™s
<a href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#discriminated-unions">discriminated union</a> concept. If we do that then <em>operation</em> property will become the discriminant of the union and after selecting appropriate operation the union type will get narrowed down to a type specific to this operation. Letâ€™s do that and export only the union type:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="17"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk14">export</span><span class="mtk1"> </span><span class="mtk4">type</span><span class="mtk1"> </span><span class="mtk9">UserInputErrorProperties</span><span class="mtk1"> =</span></span>
<span class="grvsc-line"><span class="mtk1">  | </span><span class="mtk9">AddUserErrorProperties</span></span>
<span class="grvsc-line"><span class="mtk1">  | </span><span class="mtk9">SignInErrorProperties</span></span>
<span class="grvsc-line"><span class="mtk1">  | </span><span class="mtk9">UpdateUserEmailErrorProperties</span><span class="mtk1">;</span></span></code></pre>
<p>Now letâ€™s use the union in an exemplary resolver, along with types generated by <a href="https://github.com/dotansimha/graphql-code-generator">graphql code generator</a>:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="18"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk14">export</span><span class="mtk1"> </span><span class="mtk4">async</span><span class="mtk1"> </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk10">updateUserEmailResolver</span><span class="mtk1">(</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">parent</span><span class="mtk1">: {},</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">args</span><span class="mtk1">: </span><span class="mtk9">MutationUpdateUserEmailArgs</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">ctx</span><span class="mtk1">: </span><span class="mtk9">ResolverContext</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">): </span><span class="mtk9">Promise</span><span class="mtk1">&lt;</span><span class="mtk9">UpdateUserMutationResponse</span><span class="mtk1">&gt; {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk14">try</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">updatedUser</span><span class="mtk1"> = </span><span class="mtk14">await</span><span class="mtk1"> </span><span class="mtk10">updateEmail</span><span class="mtk1">(</span><span class="mtk12">ctx</span><span class="mtk1">, {</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk12">email:</span><span class="mtk1"> </span><span class="mtk12">args</span><span class="mtk1">.</span><span class="mtk12">email</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk12">userId:</span><span class="mtk1"> </span><span class="mtk12">args</span><span class="mtk1">.</span><span class="mtk12">userId</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk12">currentPassword:</span><span class="mtk1"> </span><span class="mtk12">args</span><span class="mtk1">.</span><span class="mtk12">currentPassword</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">    });</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">mutationResponse</span><span class="mtk1">: </span><span class="mtk9">UpdateUserMutationResponse</span><span class="mtk1"> = {</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk12">isSuccess:</span><span class="mtk1"> </span><span class="mtk4">true</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk12">message:</span><span class="mtk1"> </span><span class="mtk17">&quot;User&#39;s email updated successfully&quot;</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk12">user:</span><span class="mtk1"> </span><span class="mtk12">updatedUser</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">    };</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk14">return</span><span class="mtk1"> </span><span class="mtk12">mutationResponse</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">  } </span><span class="mtk14">catch</span><span class="mtk1"> (</span><span class="mtk12">error</span><span class="mtk1">) {</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk14">if</span><span class="mtk1"> (</span><span class="mtk12">error</span><span class="mtk1"> </span><span class="mtk4">instanceof</span><span class="mtk1"> </span><span class="mtk9">InvalidPasswordError</span><span class="mtk1">) {</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">properties</span><span class="mtk1">: </span><span class="mtk9">UserInputErrorProperties</span><span class="mtk1"> = {</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk12">operation:</span><span class="mtk1"> </span><span class="mtk12">UserInputOperation</span><span class="mtk1">.</span><span class="mtk12">UpdateUserEmail</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk12">codes:</span><span class="mtk1"> [</span><span class="mtk12">UserInputErrorCode</span><span class="mtk1">.</span><span class="mtk12">InvalidPassword</span><span class="mtk1">],</span></span>
<span class="grvsc-line"><span class="mtk1">      };</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">apolloError</span><span class="mtk1"> = </span><span class="mtk4">new</span><span class="mtk1"> </span><span class="mtk9">InvalidUserInputError</span><span class="mtk1">(</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk17">&quot;Failed to update user&#39;s email, invalid credentials&quot;</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk12">properties</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">      );</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk12">apolloError</span><span class="mtk1">.</span><span class="mtk12">originalError</span><span class="mtk1"> = </span><span class="mtk12">error</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk14">throw</span><span class="mtk1"> </span><span class="mtk12">apolloError</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">    } </span><span class="mtk14">else</span><span class="mtk1"> </span><span class="mtk14">if</span><span class="mtk1"> (</span><span class="mtk12">error</span><span class="mtk1"> </span><span class="mtk4">instanceof</span><span class="mtk1"> </span><span class="mtk9">EmailExistsError</span><span class="mtk1">) {</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">properties</span><span class="mtk1">: </span><span class="mtk9">UserInputErrorProperties</span><span class="mtk1"> = {</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk12">operation:</span><span class="mtk1"> </span><span class="mtk12">UserInputOperation</span><span class="mtk1">.</span><span class="mtk12">UpdateUserEmail</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk12">codes:</span><span class="mtk1"> [</span><span class="mtk12">UserInputErrorCode</span><span class="mtk1">.</span><span class="mtk12">EmailExists</span><span class="mtk1">],</span></span>
<span class="grvsc-line"><span class="mtk1">      };</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">apolloError</span><span class="mtk1"> = </span><span class="mtk4">new</span><span class="mtk1"> </span><span class="mtk9">InvalidUserInputError</span><span class="mtk1">(</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk17">&quot;Failed to update user&#39;s email, email already registered&quot;</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">        </span><span class="mtk12">properties</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">      );</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk12">apolloError</span><span class="mtk1">.</span><span class="mtk12">originalError</span><span class="mtk1"> = </span><span class="mtk12">error</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk14">throw</span><span class="mtk1"> </span><span class="mtk12">apolloError</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">    } </span><span class="mtk14">else</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk14">throw</span><span class="mtk1"> </span><span class="mtk12">error</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">    }</span></span>
<span class="grvsc-line"><span class="mtk1">  }</span></span>
<span class="grvsc-line"><span class="mtk1">}</span></span></code></pre>
<p>When <em>updateEmail</em> service completes successfully then we build <em>mutationResponse</em> object and return it. But when it throws <em>InvalidPasswordError</em> or <em>EmailExistsError</em> then it is translated into Apolloâ€™s <em>UserInputError</em> with an appropriate <em>properties</em> object. All other errors are rethrown. In this setup when we select an operation correctly then Typescriptâ€™s compiler will not allow us to use error code other than those defined for this operation, and if we add other properties to the interface related to this operation then Typescript compiler will also display an error if we forget to add them to <em>properties</em> object created in the resolver.</p>
<p>Even bigger benefit we would gain when we exclude <em>UserInputErrorProperties</em> and related enums to a separate project, common for both client and server side. Then after using it also on the client side we could gain full type safety across the system: in case of any changes in error handling for an operation Typescript compiler would show us where the operation is used and the system would not compile until changes are synchronized in all these places. Weâ€™ll see how we could do that in the <a href="/blog/error-handling-with-apollo-client/">next post</a>.</p>
<p>Now letâ€™s handle the last category of errors - all other, unexpected errors.</p>
<h2>3. Handling unexpected errors</h2>
<p>Examples of unexpected errors might include:</p>
<ul>
<li>i/o errors related to database/filesystem/external api access issues</li>
<li>errors resulted from bugs in source code or dependencies of the project</li>
<li>etc.</li>
</ul>
<p>When no layer of our system knows how to handle an error then it is rethrown up layer by layer.
And as a sidenote, it would be a <a href="https://www.sitepoint.com/proper-error-handling-javascript/">bad practice</a> to silently suppress unexpected errors in a layer that cannot properly handle them. Before the unexpected error reaches egress we can use one more capability of Apollo Server: <a href="https://www.apollographql.com/docs/apollo-server/data/errors/#masking-and-logging-errors">masking and logging errors</a>. On instantiation Apollo Server takes <em>config</em> object as the constructor parameter and one of properties of this object is <em>formatError</em> property to which we can assign a function. If the function is provided then every error is passed through it before being transmitted outside. Letâ€™s see how the function could look like:</p>
<pre class="grvsc-container grvsc-container-additional light-default-light" data-language="typescript" data-index="19"><code class="grvsc-code"><span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">GraphQLError</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;graphql&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">ApolloError</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">AuthenticationError</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">ForbiddenError</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk12">UserInputError</span><span class="mtk1">,</span></span>
<span class="grvsc-line"><span class="mtk1">} </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;apollo-server-express&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk14">import</span><span class="mtk1"> { </span><span class="mtk12">logger</span><span class="mtk1"> } </span><span class="mtk14">from</span><span class="mtk1"> </span><span class="mtk17">&quot;./logger&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"></span>
<span class="grvsc-line"><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">path</span><span class="mtk1"> = </span><span class="mtk17">&quot;errors/&quot;</span><span class="mtk1">;</span></span>
<span class="grvsc-line"></span>
<span class="grvsc-line"><span class="mtk14">export</span><span class="mtk1"> </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk10">formatError</span><span class="mtk1">(</span><span class="mtk12">error</span><span class="mtk1">: </span><span class="mtk9">GraphQLError</span><span class="mtk1">): </span><span class="mtk9">GraphQLError</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">functionPath</span><span class="mtk1"> = </span><span class="mtk12">path</span><span class="mtk1"> + </span><span class="mtk12">formatError</span><span class="mtk1">.</span><span class="mtk12">name</span><span class="mtk1">;</span></span>
<span class="grvsc-line"></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">originalError</span><span class="mtk1"> = </span><span class="mtk12">error</span><span class="mtk1">.</span><span class="mtk12">originalError</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk14">if</span><span class="mtk1"> (</span><span class="mtk12">originalError</span><span class="mtk1"> </span><span class="mtk4">instanceof</span><span class="mtk1"> </span><span class="mtk9">ApolloError</span><span class="mtk1">) {</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk14">if</span><span class="mtk1"> (</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk12">originalError</span><span class="mtk1"> </span><span class="mtk4">instanceof</span><span class="mtk1"> </span><span class="mtk9">AuthenticationError</span><span class="mtk1"> ||</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk12">originalError</span><span class="mtk1"> </span><span class="mtk4">instanceof</span><span class="mtk1"> </span><span class="mtk9">ForbiddenError</span><span class="mtk1"> ||</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk12">originalError</span><span class="mtk1"> </span><span class="mtk4">instanceof</span><span class="mtk1"> </span><span class="mtk9">UserInputError</span></span>
<span class="grvsc-line"><span class="mtk1">    ) {</span></span>
<span class="grvsc-line"><span class="mtk1">      </span><span class="mtk12">logger</span><span class="mtk1">.</span><span class="mtk10">verbose</span><span class="mtk1">(</span><span class="mtk12">functionPath</span><span class="mtk1">, </span><span class="mtk9">JSON</span><span class="mtk1">.</span><span class="mtk10">stringify</span><span class="mtk1">(</span><span class="mtk12">error</span><span class="mtk1">));</span></span>
<span class="grvsc-line"><span class="mtk1">    }</span></span>
<span class="grvsc-line"><span class="mtk1">  } </span><span class="mtk14">else</span><span class="mtk1"> {</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">logger</span><span class="mtk1">.</span><span class="mtk10">error</span><span class="mtk1">(</span><span class="mtk12">functionPath</span><span class="mtk1">, </span><span class="mtk9">JSON</span><span class="mtk1">.</span><span class="mtk10">stringify</span><span class="mtk1">(</span><span class="mtk12">error</span><span class="mtk1">));</span></span>
<span class="grvsc-line"><span class="mtk1">  }</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk3">// Do not send stacktrace to clients:</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk14">if</span><span class="mtk1"> (</span><span class="mtk12">error</span><span class="mtk1">.</span><span class="mtk12">extensions</span><span class="mtk1">?.</span><span class="mtk12">exception</span><span class="mtk1">?.</span><span class="mtk12">stacktrace</span><span class="mtk1"> !== </span><span class="mtk4">undefined</span><span class="mtk1">) {</span></span>
<span class="grvsc-line"><span class="mtk1">    </span><span class="mtk12">error</span><span class="mtk1">.</span><span class="mtk12">extensions</span><span class="mtk1">.</span><span class="mtk12">exception</span><span class="mtk1">.</span><span class="mtk12">stacktrace</span><span class="mtk1"> = </span><span class="mtk4">undefined</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">  }</span></span>
<span class="grvsc-line"><span class="mtk1">  </span><span class="mtk14">return</span><span class="mtk1"> </span><span class="mtk12">error</span><span class="mtk1">;</span></span>
<span class="grvsc-line"><span class="mtk1">}</span></span></code></pre>
<p>In this function we filter out all errors that are related to userâ€™s invalid actions and log all other errors as actual errors that need attention. We can also clear the stacktrace so that it is not transmitted to the client application, as we donâ€™t want to expose the internal structure of our system outside. There are also <a href="https://www.apollographql.com/docs/apollo-server/data/errors/#default-information">other ways</a> to disable the stacktrace in production. After the unexpected error is processed it is transmitted outside with <em>extensions.code</em> set to <em>INTERNAL_SERVER_ERROR</em>. Such an error should be subsequently properly handled in a client applicationâ€™s UI, weâ€™ll see how to do that in the <a href="/blog/error-handling-with-apollo-client/">next post</a>.</p>
<p>Wrapping up, handling unexpected errors on the server side boils down to properly logging/reporting them - as solving issues that caused them usually requires human intervention.</p>
<h2>Summary</h2>
<p>Letâ€™s summarize, as a result of implemented changes we have a system that handles system-wide, service-specific and unexpected  errors and translates them into Apolloâ€™s errors in a type-safe way with Typescript. But most importantly, all changes have been implemented in the resolvers layer with no modifications required to layers below. As a result, apart from added GraphQL capabilities, the system works as before and can still handle REST requests, allowing for easier transition from a REST-based to a GraphQL-based system.</p>
<p>Looking forward to your comments and questions in <a href="https://www.reddit.com/r/graphql/comments/f3e4ig/handling_errors_with_apollo_client_and_server/">this reddit thread</a>.</p>
<p>In the <a href="/blog/error-handling-with-apollo-client/">next post</a> letâ€™s see how we can handle errors sent by Apollo Server on the client side.</p>
<style class="grvsc-styles">
  :root {
    --grvsc-padding-v: 1rem;
    --grvsc-padding-h: 1.5rem;
    --grvsc-padding-top: var(--grvsc-padding-v);
    --grvsc-padding-right: var(--grvsc-padding-h);
    --grvsc-padding-bottom: var(--grvsc-padding-v);
    --grvsc-padding-left: var(--grvsc-padding-h);
    --grvsc-border-radius: 8px;
  
    --grvsc-line-highlighted-background-color: transparent;
    --grvsc-line-highlighted-border-width: 4px;
    --grvsc-line-highlighted-border-color: transparent;
  }
  
  .grvsc-container {
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    padding-top: 1rem;
    padding-top: var(--grvsc-padding-top);
    padding-bottom: 1rem;
    padding-bottom: var(--grvsc-padding-bottom);
    border-radius: 8px;
    border-radius: var(--grvsc-border-radius);
    font-feature-settings: normal;
  }
  
  .grvsc-code {
    display: inline-block;
    min-width: 100%;
  }
  
  .grvsc-line {
    display: inline-block;
    box-sizing: border-box;
    width: 100%;
    padding-left: 1.5rem;
    padding-left: var(--grvsc-padding-left);
    padding-right: 1.5rem;
    padding-right: var(--grvsc-padding-right);
  }
  
  .grvsc-line-highlighted {
    background-color: var(--grvsc-line-highlighted-background-color);
    box-shadow: inset var(--grvsc-line-highlighted-border-width) 0 0 0 var(--grvsc-line-highlighted-border-color);
  }
  
  .light-default-light {
    background-color: #FFFFFF;
    color: #000000;
  }
  .light-default-light .mtk14 { color: #AF00DB; }
  .light-default-light .mtk1 { color: #000000; }
  .light-default-light .mtk4 { color: #0000FF; }
  .light-default-light .mtk10 { color: #795E26; }
  .light-default-light .mtk12 { color: #001080; }
  .light-default-light .mtk9 { color: #267F99; }
  .light-default-light .mtk3 { color: #008000; }
  .light-default-light .mtk17 { color: #A31515; }
  .light-default-light .mtk7 { color: #09885A; }
</style></div><hr class="blog-post__Divider-eho2rb-1 jvjEUU"/><ul class="blog-post__PostNavigator-eho2rb-3 dHdzzE"><li></li><li><a rel="next" href="/blog/error-handling-with-apollo-client/">Error handling with Apollo Client<!-- --> â†’</a></li></ul></main><footer>Â© <!-- -->2020<!-- -->, blog by Tomek Fojtuch, built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/error-handling-with-apollo-server/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-8ed3204e5c27ae2d5728.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-ceef87afc058962c4db9.js"],"component---src-templates-blog-post-tsx":["/component---src-templates-blog-post-tsx-52cdd10a98d92531f1e9.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-5ba84253390662f4ae85.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-d06ef32f5ae904b48478.js"]};/*]]>*/</script><script src="/blog/webpack-runtime-3ec63951e6c48ee606df.js" async=""></script><script src="/blog/styles-e4a06a68ee395de1b9be.js" async=""></script><script src="/blog/app-8ed3204e5c27ae2d5728.js" async=""></script><script src="/blog/commons-58851888e1dee723d827.js" async=""></script><script src="/blog/component---src-templates-blog-post-tsx-52cdd10a98d92531f1e9.js" async=""></script></body></html>